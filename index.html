<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人所得税计算器 - 最终优化版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #4cc9f0;
            --warning-color: #ff9e00;
            --danger-color: #f72585;
            --success-color: #4caf50;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 12px;
            --box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', sans-serif;
        }
        
        body {
            background-color: #f8fafd;
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            background-image: radial-gradient(circle at 10% 20%, rgba(91, 173, 254, 0.05) 0%, rgba(91, 173, 254, 0.05) 20%, transparent 20%, transparent 100%), radial-gradient(circle at 90% 80%, rgba(67, 97, 238, 0.05) 0%, rgba(67, 97, 238, 0.05) 20%, transparent 20%, transparent 100%);
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
            position: relative;
        }
        
        header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            margin-bottom: 30px;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        }
        
        .card-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--primary-color);
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .card-title i {
            color: var(--accent-color);
        }
        
        .card-subtitle {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 输入区域样式 */
        .input-group {
            margin-bottom: 22px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 1rem;
        }
        
        .input-with-icon {
            position: relative;
        }
        
        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 14px 14px 14px 45px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background-color: white;
            color: var(--dark-color);
        }
        
        input[type="number"]:focus, input[type="text"]:focus, select:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.15);
        }
        
        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
            font-size: 1.1rem;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .input-row {
                grid-template-columns: 1fr;
            }
        }
        
        .small-note {
            font-size: 0.85rem;
            color: var(--gray-color);
            margin-top: 5px;
            font-style: italic;
        }
        
        /* 社保公积金部分 */
        .social-security-container {
            background-color: #f8f9fe;
            border-radius: 10px;
            padding: 20px;
            margin-top: 10px;
            border: 1px solid #e6e9ff;
        }
        
        /* 社保缴纳城市卡片 */
        .city-card {
            background-color: #f8f9fe;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e6e9ff;
        }
        
        .city-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .city-btn {
            padding: 10px 20px;
            background-color: white;
            border: 2px solid var(--light-gray);
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark-color);
            transition: var(--transition);
        }
        
        .city-btn:hover {
            background-color: #f0f5ff;
            border-color: var(--primary-color);
        }
        
        .city-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* 专项附加扣除部分 */
        .deduction-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 15px;
        }
        
        @media (max-width: 992px) {
            .deduction-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .deduction-item {
            background-color: #f8f9fe;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e6e9ff;
            transition: var(--transition);
        }
        
        .deduction-item:hover {
            background-color: #f0f5ff;
        }
        
        .deduction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .deduction-title {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1rem;
        }
        
        .deduction-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .deduction-input input {
            width: 120px;
            padding: 10px;
            text-align: right;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
        }
        
        .deduction-unit {
            color: var(--gray-color);
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .deduction-desc {
            font-size: 0.85rem;
            color: var(--gray-color);
            line-height: 1.4;
            margin-top: 5px;
        }
        
        .deduction-total {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 10px;
            padding: 25px;
            margin-top: 25px;
            color: white;
        }
        
        .deduction-total-title {
            font-size: 1rem;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .deduction-total-amount {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin: 15px 0;
        }
        
        .deduction-total-breakdown {
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
            margin-top: 10px;
            opacity: 0.9;
        }
        
        /* 按钮样式 */
        .btn-primary {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 16px 30px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: var(--transition);
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, #3a56d4, #2e0a8c);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(2px);
        }
        
        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--dark-color);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .btn-secondary:hover {
            background-color: #dde1e7;
        }
        
        /* 结果部分 */
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 18px;
            border-bottom: 1px dashed var(--light-gray);
        }
        
        .result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .result-label {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .result-value {
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--primary-color);
        }
        
        .result-highlight {
            background-color: #f0f7ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
            border-left: 4px solid var(--primary-color);
        }
        
        .result-tax {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 25px;
        }
        
        .result-tax .result-label {
            color: white;
            opacity: 0.9;
        }
        
        .result-tax .result-value {
            color: white;
            font-size: 1.5rem;
        }
        
        /* 税收倒计时 */
        .tax-countdown {
            background: linear-gradient(135deg, #ff9e00 0%, #ff6b00 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
            text-align: center;
        }
        
        .countdown-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .countdown-amount {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .countdown-desc {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        /* 税负优化建议 */
        .optimization-suggestions {
            background-color: #f0f7ff;
            border-radius: 10px;
            padding: 25px;
            margin-top: 25px;
            border-left: 4px solid var(--success-color);
        }
        
        .suggestion-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #c5dcff;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .suggestion-icon {
            background-color: var(--success-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .suggestion-content h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .suggestion-content p {
            color: var(--dark-color);
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        /* 税负模拟器 */
        .simulator-container {
            background-color: #f8f9fe;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .simulator-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .simulator-btn {
            background-color: white;
            border: 2px solid var(--light-gray);
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark-color);
            transition: var(--transition);
        }
        
        .simulator-btn:hover {
            background-color: #f0f5ff;
            border-color: var(--primary-color);
        }
        
        .simulator-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .simulator-results {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .simulator-results {
                grid-template-columns: 1fr;
            }
        }
        
        .simulator-result {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .simulator-result-title {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .simulator-result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dotted var(--light-gray);
        }
        
        /* 税负排行榜 */
        .ranking-container {
            background-color: #f8f9fe;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        }
        
        .ranking-position {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            width: 50px;
            text-align: center;
        }
        
        .ranking-info {
            flex: 1;
        }
        
        .ranking-name {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 5px;
        }
        
        .ranking-details {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: var(--gray-color);
        }
        
        .ranking-tax {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* 税率档位颜色预警 */
        .tax-rate-warning {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .warning-low {
            background-color: #e7f4ff;
            color: var(--primary-color);
        }
        
        .warning-medium {
            background-color: #fff4e6;
            color: var(--warning-color);
        }
        
        .warning-high {
            background-color: #ffe6ee;
            color: var(--danger-color);
        }
        
        /* 图表样式 */
        .chart-container {
            height: 300px;
            margin-top: 20px;
            position: relative;
        }
        
        /* 历史记录 */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .history-item {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }
        
        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .history-date {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-bottom: 10px;
        }
        
        .history-data {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .history-data {
                grid-template-columns: 1fr;
            }
        }
        
        /* 税率表 */
        .tax-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .tax-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .tax-table tr:nth-child(even) {
            background-color: #f8f9fe;
        }
        
        .tax-table td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .current-tax-rate {
            background-color: #f0f7ff !important;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* 页脚 */
        footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 25px;
            border-top: 1px solid var(--light-gray);
            color: var(--gray-color);
            font-size: 0.95rem;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            header {
                padding: 20px;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .card-title {
                font-size: 1.3rem;
            }
            
            .city-selector {
                gap: 10px;
            }
            
            .city-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }
        
        /* 标签样式 */
        .tag {
            display: inline-block;
            padding: 4px 10px;
            background-color: #e7f4ff;
            color: var(--primary-color);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        /* 布局网格 */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-top: 30px;
        }
        
        @media (max-width: 1200px) {
            .features-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-color);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--light-gray);
        }
        
        /* 进度条 */
        .progress-bar {
            height: 8px;
            background-color: var(--light-gray);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--accent-color), var(--primary-color));
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        /* 工具提示 */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark-color);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* 起征点备注 */
        .threshold-note {
            font-size: 0.85rem;
            color: var(--gray-color);
            margin-top: 5px;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* 应纳税所得额计算公式 */
        .formula-container {
            background-color: #f8f9fe;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid var(--accent-color);
        }
        
        .formula-title {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .formula-content {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--dark-color);
        }
        
        .formula-equation {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            text-align: center;
            border: 1px solid var(--light-gray);
        }
        
        /* 年终奖计税模式切换 */
        .bonus-tax-mode {
            background-color: #f8f9fe;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e6e9ff;
        }
        
        .mode-switch {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .mode-label {
            font-weight: 600;
            color: var(--dark-color);
            font-size: 1rem;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .mode-description {
            font-size: 0.9rem;
            color: var(--gray-color);
            line-height: 1.5;
        }
        
        .mode-active {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* 左侧区域 */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        /* 右侧区域 */
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        /* 税负历史对比区域 */
        .history-chart-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-calculator"></i> 个人所得税计算器</h1>
            <p>精准计算个人所得税，提供税负优化建议、模拟器、排行榜和可视化分析</p>
        </header>
        
        <div class="main-content">
            <div class="left-column">
                <!-- 输入区域 -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-edit"></i> 收入与扣除信息</h2>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label for="salary">月薪工资 (元)</label>
                            <div class="input-with-icon">
                                <i class="fas fa-money-bill-wave input-icon"></i>
                                <input type="number" id="salary" min="0" max="1000000" step="100" value="15000" placeholder="请输入您的月薪">
                            </div>
                            <div class="threshold-note">
                                <i class="fas fa-info-circle"></i> 起征点5000元/月
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="bonus">年终奖金 (元)</label>
                            <div class="input-with-icon">
                                <i class="fas fa-gift input-icon"></i>
                                <input type="number" id="bonus" min="0" max="1000000" step="100" value="30000" placeholder="请输入您的年终奖金">
                            </div>
                            <div class="small-note">年度奖金、年终奖、13薪等一次性奖金收入</div>
                        </div>
                    </div>
                    
                    <!-- 年终奖计税模式切换 -->
                    <div class="bonus-tax-mode">
                        <div class="mode-switch">
                            <span class="mode-label">年终奖计税模式:</span>
                            <label class="switch">
                                <input type="checkbox" id="bonus-tax-toggle">
                                <span class="slider"></span>
                            </label>
                            <span class="mode-label" id="bonus-tax-mode-label">单独计税</span>
                        </div>
                        <div class="mode-description">
                            当前模式: <span class="mode-active" id="bonus-tax-mode-desc">单独计税</span> - 
                            <span id="bonus-tax-mode-explanation">年终奖单独计算税额，不并入年度综合所得</span>
                        </div>
                    </div>
                    
                    <div class="social-security-container">
                        <div class="input-row">
                            <div class="input-group">
                                <label for="pension">养老保险 (元)</label>
                                <div class="input-with-icon">
                                    <i class="fas fa-shield-alt input-icon"></i>
                                    <input type="number" id="pension" min="0" max="10000" step="10" value="1200">
                                </div>
                                <div class="small-note">个人单方缴纳部分</div>
                            </div>
                            
                            <div class="input-group">
                                <label for="medical">医疗保险 (元)</label>
                                <div class="input-with-icon">
                                    <i class="fas fa-heartbeat input-icon"></i>
                                    <input type="number" id="medical" min="0" max="10000" step="10" value="300">
                                </div>
                                <div class="small-note">个人单方缴纳部分</div>
                            </div>
                        </div>
                        
                        <div class="input-row">
                            <div class="input-group">
                                <label for="unemployment">失业保险 (元)</label>
                                <div class="input-with-icon">
                                    <i class="fas fa-user-shield input-icon"></i>
                                    <input type="number" id="unemployment" min="0" max="10000" step="10" value="30">
                                </div>
                                <div class="small-note">个人单方缴纳部分</div>
                            </div>
                            
                            <div class="input-group">
                                <label for="housing">住房公积金 (元)</label>
                                <div class="input-with-icon">
                                    <i class="fas fa-home input-icon"></i>
                                    <input type="number" id="housing" min="0" max="10000" step="10" value="1800">
                                </div>
                                <div class="small-note">个人单方缴纳部分</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <h3 class="card-subtitle"><i class="fas fa-list-alt"></i> 专项附加扣除</h3>
                        
                        <div class="deduction-grid">
                            <div class="deduction-item">
                                <div class="deduction-header">
                                    <span class="deduction-title">子女教育</span>
                                    <div class="deduction-input">
                                        <input type="number" id="children-education" min="0" max="2000" step="100" value="1000">
                                        <span class="deduction-unit">元/月</span>
                                    </div>
                                </div>
                                <div class="deduction-desc">每个子女每月最高1000元，最多2000元</div>
                            </div>
                            
                            <div class="deduction-item">
                                <div class="deduction-header">
                                    <span class="deduction-title">继续教育</span>
                                    <div class="deduction-input">
                                        <input type="number" id="continuing-education" min="0" max="400" step="100" value="400">
                                        <span class="deduction-unit">元/月</span>
                                    </div>
                                </div>
                                <div class="deduction-desc">学历教育每月400元，职业资格教育定额3600元/年</div>
                            </div>
                            
                            <div class="deduction-item">
                                <div class="deduction-header">
                                    <span class="deduction-title">大病医疗</span>
                                    <div class="deduction-input">
                                        <input type="number" id="medical-treatment" min="0" max="6667" step="100" value="0">
                                        <span class="deduction-unit">元/月</span>
                                    </div>
                                </div>
                                <div class="deduction-desc">年度限额80000元，超过15000元部分可扣除</div>
                            </div>
                            
                            <div class="deduction-item">
                                <div class="deduction-header">
                                    <span class="deduction-title">住房贷款利息</span>
                                    <div class="deduction-input">
                                        <input type="number" id="housing-loan" min="0" max="1000" step="100" value="1000">
                                        <span class="deduction-unit">元/月</span>
                                    </div>
                                </div>
                                <div class="deduction-desc">首套住房贷款利息，每月1000元，最长240个月</div>
                            </div>
                            
                            <div class="deduction-item">
                                <div class="deduction-header">
                                    <span class="deduction-title">住房租金</span>
                                    <div class="deduction-input">
                                        <input type="number" id="housing-rent" min="0" max="1500" step="100" value="0">
                                        <span class="deduction-unit">元/月</span>
                                    </div>
                                </div>
                                <div class="deduction-desc">根据城市不同，每月800-1500元</div>
                            </div>
                            
                            <div class="deduction-item">
                                <div class="deduction-header">
                                    <span class="deduction-title">赡养老人</span>
                                    <div class="deduction-input">
                                        <input type="number" id="support-elderly" min="0" max="2000" step="100" value="0">
                                        <span class="deduction-unit">元/月</span>
                                    </div>
                                </div>
                                <div class="deduction-desc">赡养60岁以上父母，每月2000元</div>
                            </div>
                            
                            <div class="deduction-item">
                                <div class="deduction-header">
                                    <span class="deduction-title">3岁以下婴幼儿照护</span>
                                    <div class="deduction-input">
                                        <input type="number" id="infant-care" min="0" max="1000" step="100" value="0">
                                        <span class="deduction-unit">元/月</span>
                                    </div>
                                </div>
                                <div class="deduction-desc">3岁以下婴幼儿，每个每月1000元</div>
                            </div>
                            
                            <div class="deduction-item">
                                <div class="deduction-header">
                                    <span class="deduction-title">其他扣除</span>
                                    <div class="deduction-input">
                                        <input type="number" id="other-deduction" min="0" max="10000" step="100" value="0">
                                        <span class="deduction-unit">元/月</span>
                                    </div>
                                </div>
                                <div class="deduction-desc">年金、商业健康保险、税收递延型养老保险等</div>
                            </div>
                        </div>
                        
                        <div class="deduction-total">
                            <div class="deduction-total-title">月扣除总额</div>
                            <div class="deduction-total-amount" id="monthly-deduction-total">¥2,400.00</div>
                            <div class="deduction-total-breakdown">
                                <span>每月专项附加扣除</span>
                                <span id="monthly-deduction-number">2,400 元</span>
                            </div>
                            <div class="deduction-total-breakdown">
                                <span>年度专项附加扣除</span>
                                <span id="annual-deduction-total">28,800 元</span>
                            </div>
                        </div>
                    </div>
                    
                    <button id="calculate-btn" class="btn-primary">
                        <i class="fas fa-calculator"></i> 计算个人所得税
                    </button>
                </div>
                
                <!-- 计算结果 -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-chart-pie"></i> 计算结果</h2>
                    
                    <div class="result-item">
                        <span class="result-label">月薪工资:</span>
                        <span class="result-value" id="result-salary">15,000 元</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">年终奖金:</span>
                        <span class="result-value" id="result-bonus">30,000 元</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">年度总收入:</span>
                        <span class="result-value" id="result-total-income">210,000 元</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">社保公积金(年):</span>
                        <span class="result-value" id="result-insurance">39,960 元</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">专项附加扣除(年):</span>
                        <span class="result-value" id="result-deduction">28,800 元</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">年度应纳税所得额:</span>
                        <span class="result-value" id="result-taxable-income">81,240 元</span>
                    </div>
                    
                    <div class="result-highlight">
                        <h4>个税计算明细：</h4>
                        <div class="result-item">
                            <span class="result-label">适用税率:</span>
                            <span class="result-value" id="breakdown-rate">3% <span class="tax-rate-warning warning-low" id="rate-warning">低税负</span></span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">速算扣除数:</span>
                            <span class="result-value" id="breakdown-quick-deduction">0 元</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">年度应纳税额:</span>
                            <span class="result-value" id="breakdown-annual-tax">2,437 元</span>
                        </div>
                    </div>
                    
                    <div class="result-tax">
                        <div class="result-item">
                            <span class="result-label">每月预扣税额:</span>
                            <span class="result-value" id="result-monthly-tax">203 元</span>
                        </div>
                        
                        <div class="result-item">
                            <span class="result-label">年度应缴个税总额:</span>
                            <span class="result-value" id="result-annual-tax">2,437 元</span>
                        </div>
                        
                        <div class="result-item">
                            <span class="result-label">税后年收入:</span>
                            <span class="result-value" id="result-after-tax-income">207,563 元</span>
                        </div>
                    </div>
                    
                    <!-- 应纳税所得额计算公式 -->
                    <div class="formula-container">
                        <div class="formula-title">
                            <i class="fas fa-calculator"></i> 应纳税所得额计算公式
                        </div>
                        <div class="formula-content">
                            年度应纳税所得额 = 年度总收入 - 基本减除费用(60,000元/年) - 社保公积金 - 专项附加扣除
                        </div>
                        <div class="formula-equation" id="formula-equation">
                            210,000 - 60,000 - 39,960 - 28,800 = 81,240 元
                        </div>
                    </div>
                    
                    <!-- 税收倒计时 -->
                    <div class="tax-countdown" id="tax-countdown">
                        <div class="countdown-title">
                            <i class="fas fa-hourglass-half"></i> 距下个税率档
                        </div>
                        <div class="countdown-amount" id="countdown-amount">¥18,760</div>
                        <div class="countdown-desc" id="countdown-desc">再增加 <strong>18,760元</strong> 年收入将进入10%税率档</div>
                    </div>
                    
                    <div class="result-highlight">
                        <h4>税收节省分析：</h4>
                        <div class="result-item">
                            <span class="result-label">专项附加扣除节省税额:</span>
                            <span class="result-value" id="tax-saving">864 元</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">社保公积金节省税额:</span>
                            <span class="result-value" id="insurance-saving">1,198 元</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">综合节省比例:</span>
                            <span class="result-value" id="saving-percentage">45.8%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="tax-saving-progress" style="width: 45.8%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 税负优化建议 -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-lightbulb"></i> 税负优化建议</h2>
                    <div class="optimization-suggestions" id="optimization-suggestions">
                        <!-- 优化建议将动态生成 -->
                        <div class="suggestion-item">
                            <div class="suggestion-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="suggestion-content">
                                <h4>充分利用住房租金扣除</h4>
                                <p>如果您在工作城市没有自有住房而租房居住，可以享受住房租金专项附加扣除。根据城市级别，每月可扣除800-1500元。</p>
                            </div>
                        </div>
                        
                        <div class="suggestion-item">
                            <div class="suggestion-icon">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <div class="suggestion-content">
                                <h4>继续教育扣除</h4>
                                <p>参加学历（学位）继续教育的纳税人，每月可扣除400元。参加职业资格继续教育并在取得证书的当年，可定额扣除3600元。</p>
                            </div>
                        </div>
                        
                        <div class="suggestion-item">
                            <div class="suggestion-icon">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="suggestion-content">
                                <h4>商业健康保险扣除</h4>
                                <p>购买符合规定的商业健康保险产品，每月可扣除200元，年度限额2400元。这是降低税负的有效方式之一。</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 社保缴纳城市 -->
                <div class="card city-card">
                    <h2 class="card-title"><i class="fas fa-map-marker-alt"></i> 社保缴纳城市</h2>
                    <p>选择您缴纳社保和公积金所在的城市，不同城市的缴费比例和基数上限不同</p>
                    
                    <div class="city-selector">
                        <button type="button" class="city-btn active" data-city="beijing">北京</button>
                        <button type="button" class="city-btn" data-city="shanghai">上海</button>
                        <button type="button" class="city-btn" data-city="guangzhou">广州</button>
                        <button type="button" class="city-btn" data-city="shenzhen">深圳</button>
                        <button type="button" class="city-btn" data-city="hangzhou">杭州</button>
                        <button type="button" class="city-btn" data-city="chengdu">成都</button>
                    </div>
                    
                    <div class="city-policy" id="city-policy">
                        <div class="small-note">选择城市后，系统会根据当地社保政策自动计算各项保险金额</div>
                    </div>
                </div>
            </div>
            
            <div class="right-column">
                <!-- 税负模拟器 -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-chart-line"></i> 税负模拟器</h2>
                    <p>对比不同收入方案，找到最优税务规划策略</p>
                    
                    <div class="simulator-container">
                        <div class="simulator-controls">
                            <button class="simulator-btn active" data-scenario="current">当前方案</button>
                            <button class="simulator-btn" data-scenario="optimize">优化方案</button>
                            <button class="simulator-btn" data-scenario="increase-salary">增加月薪</button>
                            <button class="simulator-btn" data-scenario="increase-bonus">增加年终奖</button>
                            <button class="simulator-btn" data-scenario="deduction-max">最大化扣除</button>
                        </div>
                        
                        <div class="simulator-results" id="simulator-results">
                            <!-- 模拟结果将动态生成 -->
                        </div>
                    </div>
                </div>
                
                <!-- 税负历史对比曲线图 -->
                <div class="history-chart-container">
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-chart-bar"></i> 税负历史对比</h2>
                        <p>您的个税变化趋势与历史记录</p>
                        
                        <div class="chart-container">
                            <canvas id="taxHistoryChart"></canvas>
                        </div>
                        
                        <div class="history-list" id="history-list" style="max-height: 200px; margin-top: 20px;">
                            <!-- 历史记录将在这里动态生成 -->
                            <div class="empty-state" id="empty-history">
                                <i class="fas fa-history"></i>
                                <h3>暂无历史记录</h3>
                                <p>开始计算个人所得税后，您的计算记录将显示在这里</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 税负排行榜 -->
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-trophy"></i> 税负排行榜</h2>
                        <p>全国个人所得税缴纳情况排名</p>
                        
                        <div class="ranking-container" id="ranking-container">
                            <!-- 排行榜将动态生成 -->
                            <div class="ranking-item">
                                <div class="ranking-position">1</div>
                                <div class="ranking-info">
                                    <div class="ranking-name">北京市 - 张先生</div>
                                    <div class="ranking-details">
                                        <span>月薪: 35,000元</span>
                                        <span class="ranking-tax">年个税: 48,520元</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ranking-item">
                                <div class="ranking-position">2</div>
                                <div class="ranking-info">
                                    <div class="ranking-name">上海市 - 李女士</div>
                                    <div class="ranking-details">
                                        <span>月薪: 32,000元</span>
                                        <span class="ranking-tax">年个税: 41,280元</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ranking-item">
                                <div class="ranking-position">3</div>
                                <div class="ranking-info">
                                    <div class="ranking-name">深圳市 - 王先生</div>
                                    <div class="ranking-details">
                                        <span>月薪: 28,000元</span>
                                        <span class="ranking-tax">年个税: 33,600元</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ranking-item">
                                <div class="ranking-position">4</div>
                                <div class="ranking-info">
                                    <div class="ranking-name">广州市 - 刘女士</div>
                                    <div class="ranking-details">
                                        <span>月薪: 25,000元</span>
                                        <span class="ranking-tax">年个税: 26,400元</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ranking-item">
                                <div class="ranking-position">5</div>
                                <div class="ranking-info">
                                    <div class="ranking-name">杭州市 - 陈先生</div>
                                    <div class="ranking-details">
                                        <span>月薪: 22,000元</span>
                                        <span class="ranking-tax">年个税: 21,120元</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 税率表 -->
        <div class="card">
            <h2 class="card-title"><i class="fas fa-percentage"></i> 个人所得税税率表（综合所得适用）</h2>
            <p>本表适用于居民个人工资、薪金所得、劳务报酬所得、稿酬所得、特许权使用费所得预扣预缴个人所得税的计算</p>
            
            <table class="tax-table" id="tax-table">
                <thead>
                    <tr>
                        <th>级数</th>
                        <th>全年应纳税所得额</th>
                        <th>税率 (%)</th>
                        <th>速算扣除数</th>
                        <th>示例说明</th>
                        <th>税负预警</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 税率表数据将由JavaScript动态生成并高亮显示当前税率 -->
                </tbody>
            </table>
        </div>
        
        <footer>
            <p>个人所得税计算器 - 最终优化版 &copy; 2023 | 数据根据中国现行个人所得税法计算</p>
            <p>本工具仅用于参考，实际税务问题请咨询专业税务机构</p>
        </footer>
    </div>

    <script>
        // 个人所得税税率表（年度）
        const taxRateTable = [
            { level: 1, min: 0, max: 36000, rate: 0.03, quickDeduction: 0, example: "不超过36,000元的部分", warning: "低" },
            { level: 2, min: 36000, max: 144000, rate: 0.10, quickDeduction: 2520, example: "超过36,000元至144,000元的部分", warning: "中" },
            { level: 3, min: 144000, max: 300000, rate: 0.20, quickDeduction: 16920, example: "超过144,000元至300,000元的部分", warning: "中" },
            { level: 4, min: 300000, max: 420000, rate: 0.25, quickDeduction: 31920, example: "超过300,000元至420,000元的部分", warning: "高" },
            { level: 5, min: 420000, max: 660000, rate: 0.30, quickDeduction: 52920, example: "超过420,000元至660,000元的部分", warning: "高" },
            { level: 6, min: 660000, max: 960000, rate: 0.35, quickDeduction: 85920, example: "超过660,000元至960,000元的部分", warning: "高" },
            { level: 7, min: 960000, max: Infinity, rate: 0.45, quickDeduction: 181920, example: "超过960,000元的部分", warning: "极高" }
        ];

        // 年终奖单独计税税率表
        const bonusTaxRateTable = [
            { min: 0, max: 3000, rate: 0.03, quickDeduction: 0 },
            { min: 3000, max: 12000, rate: 0.10, quickDeduction: 210 },
            { min: 12000, max: 25000, rate: 0.20, quickDeduction: 1410 },
            { min: 25000, max: 35000, rate: 0.25, quickDeduction: 2660 },
            { min: 35000, max: 55000, rate: 0.30, quickDeduction: 4410 },
            { min: 55000, max: 80000, rate: 0.35, quickDeduction: 7160 },
            { min: 80000, max: Infinity, rate: 0.45, quickDeduction: 15160 }
        ];

        // 城市社保政策数据
        const cityPolicies = {
            beijing: {
                name: "北京",
                pension: 0.08,
                medical: 0.02,
                unemployment: 0.002,
                housing: 0.12,
                description: "北京社保公积金比例较高，尤其是住房公积金，最高可达12%"
            },
            shanghai: {
                name: "上海",
                pension: 0.08,
                medical: 0.02,
                unemployment: 0.005,
                housing: 0.07,
                description: "上海社保比例与北京相似，但住房公积金比例较低，为7%"
            },
            guangzhou: {
                name: "广州",
                pension: 0.08,
                medical: 0.02,
                unemployment: 0.002,
                housing: 0.12,
                description: "广州社保公积金比例与北京相似，住房公积金最高可达12%"
            },
            shenzhen: {
                name: "深圳",
                pension: 0.08,
                medical: 0.02,
                unemployment: 0.003,
                housing: 0.05,
                description: "深圳社保比例较低，尤其是住房公积金，比例为5%"
            },
            hangzhou: {
                name: "杭州",
                pension: 0.08,
                medical: 0.02,
                unemployment: 0.005,
                housing: 0.12,
                description: "杭州社保比例较高，尤其是住房公积金，最高可达12%"
            },
            chengdu: {
                name: "成都",
                pension: 0.08,
                medical: 0.02,
                unemployment: 0.004,
                housing: 0.12,
                description: "成都社保公积金比例较高，住房公积金最高可达12%"
            }
        };

        // 当前城市
        let currentCity = 'beijing';
        
        // 历史记录数组
        let taxHistory = [];
        
        // 图表实例
        let taxHistoryChart = null;
        
        // 年终奖计税模式（true为单独计税，false为并入综合所得）
        let bonusTaxSeparate = true;

        // 获取DOM元素
        const salaryInput = document.getElementById('salary');
        const bonusInput = document.getElementById('bonus');
        
        // 社保公积金输入框
        const pensionInput = document.getElementById('pension');
        const medicalInput = document.getElementById('medical');
        const unemploymentInput = document.getElementById('unemployment');
        const housingInput = document.getElementById('housing');
        
        // 城市选择按钮
        const cityButtons = document.querySelectorAll('.city-btn');
        
        // 专项附加扣除输入框
        const childrenEducationInput = document.getElementById('children-education');
        const continuingEducationInput = document.getElementById('continuing-education');
        const medicalTreatmentInput = document.getElementById('medical-treatment');
        const housingLoanInput = document.getElementById('housing-loan');
        const housingRentInput = document.getElementById('housing-rent');
        const supportElderlyInput = document.getElementById('support-elderly');
        const infantCareInput = document.getElementById('infant-care');
        const otherDeductionInput = document.getElementById('other-deduction');
        
        // 计算按钮
        const calculateBtn = document.getElementById('calculate-btn');
        
        // 模拟器按钮
        const simulatorButtons = document.querySelectorAll('.simulator-btn');
        
        // 年终奖计税模式切换
        const bonusTaxToggle = document.getElementById('bonus-tax-toggle');
        const bonusTaxModeLabel = document.getElementById('bonus-tax-mode-label');
        const bonusTaxModeDesc = document.getElementById('bonus-tax-mode-desc');
        const bonusTaxModeExplanation = document.getElementById('bonus-tax-mode-explanation');
        
        // 初始化函数
        function init() {
            // 从本地存储加载历史记录
            loadHistory();
            
            // 初始化税率表
            initTaxTable();
            
            // 初始化事件监听器
            initEventListeners();
            
            // 初始化城市政策
            updateCityPolicy();
            
            // 计算初始税额
            const result = calculateTax();
            
            // 生成优化建议
            generateOptimizationSuggestions(result);
            
            // 更新模拟器
            updateSimulator(result);
            
            // 更新排行榜
            updateRanking();
            
            // 初始化图表
            initChart();
            
            // 初始化年终奖计税模式
            updateBonusTaxMode();
        }

        // 初始化税率表
        function initTaxTable() {
            const tbody = document.querySelector('#tax-table tbody');
            tbody.innerHTML = '';
            
            taxRateTable.forEach(item => {
                const row = document.createElement('tr');
                row.id = `tax-level-${item.level}`;
                
                const maxDisplay = item.max === Infinity ? "以上" : `至 ${formatCurrency(item.max)}`;
                
                // 根据预警级别设置颜色
                let warningClass = '';
                let warningText = '';
                switch(item.warning) {
                    case '低': warningClass = 'warning-low'; warningText = '低税负'; break;
                    case '中': warningClass = 'warning-medium'; warningText = '中等税负'; break;
                    case '高': warningClass = 'warning-high'; warningText = '高税负'; break;
                    case '极高': warningClass = 'warning-high'; warningText = '极高税负'; break;
                }
                
                row.innerHTML = `
                    <td>${item.level}</td>
                    <td>超过 ${formatCurrency(item.min)} 元 ${maxDisplay}</td>
                    <td>${(item.rate * 100).toFixed(0)}%</td>
                    <td>${formatCurrency(item.quickDeduction)} 元</td>
                    <td>${item.example}</td>
                    <td><span class="tax-rate-warning ${warningClass}">${warningText}</span></td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // 格式化货币显示
        function formatCurrency(value) {
            return value.toLocaleString('zh-CN', { maximumFractionDigits: 0 });
        }

        // 格式化货币显示（带两位小数）
        function formatCurrencyDecimal(value) {
            return value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // 更新城市政策显示
        function updateCityPolicy() {
            const policy = cityPolicies[currentCity];
            
            // 更新城市选择按钮状态
            cityButtons.forEach(btn => {
                if (btn.dataset.city === currentCity) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // 更新年终奖计税模式显示
        function updateBonusTaxMode() {
            if (bonusTaxSeparate) {
                bonusTaxToggle.checked = true;
                bonusTaxModeLabel.textContent = "单独计税";
                bonusTaxModeDesc.textContent = "单独计税";
                bonusTaxModeExplanation.textContent = "年终奖单独计算税额，不并入年度综合所得";
            } else {
                bonusTaxToggle.checked = false;
                bonusTaxModeLabel.textContent = "并入综合所得";
                bonusTaxModeDesc.textContent = "并入综合所得";
                bonusTaxModeExplanation.textContent = "年终奖并入年度综合所得统一计算税额";
            }
        }

        // 自动计算社保公积金
        function autoCalculateInsurance() {
            const monthlySalary = parseFloat(salaryInput.value) || 0;
            const policy = cityPolicies[currentCity];
            
            // 计算各项保险
            const pension = monthlySalary * policy.pension;
            const medical = monthlySalary * policy.medical;
            const unemployment = monthlySalary * policy.unemployment;
            const housing = monthlySalary * policy.housing;
            
            // 更新输入框值
            pensionInput.value = Math.round(pension);
            medicalInput.value = Math.round(medical);
            unemploymentInput.value = Math.round(unemployment);
            housingInput.value = Math.round(housing);
            
            // 触发计算
            calculateTax();
        }

        // 计算专项附加扣除总额并更新显示
        function calculateDeductionTotal() {
            // 获取各项专项附加扣除值
            const childrenEducation = parseFloat(childrenEducationInput.value) || 0;
            const continuingEducation = parseFloat(continuingEducationInput.value) || 0;
            const medicalTreatment = parseFloat(medicalTreatmentInput.value) || 0;
            const housingLoan = parseFloat(housingLoanInput.value) || 0;
            const housingRent = parseFloat(housingRentInput.value) || 0;
            const supportElderly = parseFloat(supportElderlyInput.value) || 0;
            const infantCare = parseFloat(infantCareInput.value) || 0;
            const otherDeduction = parseFloat(otherDeductionInput.value) || 0;
            
            // 计算每月专项附加扣除总额
            const monthlyDeductionTotal = childrenEducation + continuingEducation + medicalTreatment + 
                                         housingLoan + housingRent + supportElderly + infantCare + otherDeduction;
            
            // 计算年度专项附加扣除总额
            const annualDeductionTotal = monthlyDeductionTotal * 12;
            
            // 更新专项附加扣除总额显示
            document.getElementById('monthly-deduction-total').textContent = `¥${formatCurrencyDecimal(monthlyDeductionTotal)}`;
            document.getElementById('monthly-deduction-number').textContent = `${formatCurrency(monthlyDeductionTotal)} 元`;
            document.getElementById('annual-deduction-total').textContent = `${formatCurrency(annualDeductionTotal)} 元`;
            
            return {
                monthly: monthlyDeductionTotal,
                annual: annualDeductionTotal
            };
        }

        // 计算个人所得税（含年终奖单独计税）
        function calculateTax() {
            // 获取输入值
            const monthlySalary = parseFloat(salaryInput.value) || 0;
            const annualBonus = parseFloat(bonusInput.value) || 0;
            
            // 获取社保公积金值
            const pension = parseFloat(pensionInput.value) || 0;
            const medical = parseFloat(medicalInput.value) || 0;
            const unemployment = parseFloat(unemploymentInput.value) || 0;
            const housing = parseFloat(housingInput.value) || 0;
            
            // 计算专项附加扣除总额
            const deductionTotal = calculateDeductionTotal();
            const monthlyDeduction = deductionTotal.monthly;
            const annualDeduction = deductionTotal.annual;
            
            // 计算年度总额
            const annualSalary = monthlySalary * 12;
            const monthlyInsurance = pension + medical + unemployment + housing;
            const annualInsurance = monthlyInsurance * 12;
            
            // 年度总收入
            const annualTotalIncome = annualSalary + annualBonus;
            
            // 基本减除费用（年度）
            const basicDeduction = 60000;
            
            let annualTax = 0;
            let taxableIncome = 0;
            let applicableRate = taxRateTable[0];
            let bonusTax = 0;
            
            if (bonusTaxSeparate) {
                // 年终奖单独计税模式
                
                // 1. 计算综合所得应纳税额
                const salaryTaxableIncome = Math.max(0, annualSalary - basicDeduction - annualInsurance - annualDeduction);
                taxableIncome = salaryTaxableIncome;
                
                // 查找适用的税率
                for (const rate of taxRateTable) {
                    if (salaryTaxableIncome > rate.min && salaryTaxableIncome <= rate.max) {
                        applicableRate = rate;
                        break;
                    } else if (salaryTaxableIncome > rate.max && rate.max === Infinity) {
                        applicableRate = rate;
                        break;
                    }
                }
                
                const salaryTax = salaryTaxableIncome * applicableRate.rate - applicableRate.quickDeduction;
                
                // 2. 计算年终奖应纳税额
                if (annualBonus > 0) {
                    // 年终奖单独计税，按月换算
                    const monthlyBonus = annualBonus / 12;
                    
                    // 查找适用的年终奖税率
                    let bonusRate = bonusTaxRateTable[0];
                    for (const rate of bonusTaxRateTable) {
                        if (monthlyBonus > rate.min && monthlyBonus <= rate.max) {
                            bonusRate = rate;
                            break;
                        } else if (monthlyBonus > rate.max && rate.max === Infinity) {
                            bonusRate = rate;
                            break;
                        }
                    }
                    
                    // 年终奖应纳税额 = 年终奖 × 适用税率 - 速算扣除数
                    bonusTax = annualBonus * bonusRate.rate - bonusRate.quickDeduction;
                }
                
                // 3. 合计应纳税额
                annualTax = salaryTax + bonusTax;
            } else {
                // 年终奖并入综合所得计税模式
                
                // 计算年度应纳税所得额
                const annualTaxableIncome = Math.max(0, annualTotalIncome - basicDeduction - annualInsurance - annualDeduction);
                taxableIncome = annualTaxableIncome;
                
                // 查找适用的税率
                for (const rate of taxRateTable) {
                    if (annualTaxableIncome > rate.min && annualTaxableIncome <= rate.max) {
                        applicableRate = rate;
                        break;
                    } else if (annualTaxableIncome > rate.max && rate.max === Infinity) {
                        applicableRate = rate;
                        break;
                    }
                }
                
                // 计算年度应纳税额
                annualTax = annualTaxableIncome * applicableRate.rate - applicableRate.quickDeduction;
            }
            
            // 每月预扣税额（平均）
            const monthlyTax = annualTax / 12;
            
            // 税后年收入
            const afterTaxIncome = annualTotalIncome - annualTax;
            
            // 计算税收倒计时（距离下一个税率档的差额）
            let nextRate = null;
            for (let i = 0; i < taxRateTable.length; i++) {
                const rate = taxRateTable[i];
                if (taxableIncome > rate.min && taxableIncome <= rate.max) {
                    nextRate = taxRateTable[i + 1] || null;
                    break;
                } else if (taxableIncome > rate.max && rate.max === Infinity) {
                    nextRate = null;
                    break;
                }
            }
            
            let countdownAmount = 0;
            let countdownDesc = '';
            if (nextRate) {
                countdownAmount = nextRate.min - taxableIncome;
                countdownDesc = `再增加 <strong>${formatCurrency(countdownAmount)}元</strong> 年收入将进入${(nextRate.rate * 100).toFixed(0)}%税率档`;
            } else {
                countdownAmount = 0;
                countdownDesc = '您已处于最高税率档';
            }
            
            // 计算无扣除时的税额（用于节省分析）
            const taxableIncomeNoDeduction = Math.max(0, annualTotalIncome - basicDeduction - annualInsurance);
            let applicableRateNoDeduction = taxRateTable[0];
            for (const rate of taxRateTable) {
                if (taxableIncomeNoDeduction > rate.min && taxableIncomeNoDeduction <= rate.max) {
                    applicableRateNoDeduction = rate;
                    break;
                }
            }
            
            let annualTaxNoDeduction = 0;
            if (bonusTaxSeparate) {
                // 单独计税模式下，无扣除时的税额
                const salaryTaxableIncomeNoDeduction = Math.max(0, annualSalary - basicDeduction - annualInsurance);
                let salaryRateNoDeduction = taxRateTable[0];
                for (const rate of taxRateTable) {
                    if (salaryTaxableIncomeNoDeduction > rate.min && salaryTaxableIncomeNoDeduction <= rate.max) {
                        salaryRateNoDeduction = rate;
                        break;
                    }
                }
                const salaryTaxNoDeduction = salaryTaxableIncomeNoDeduction * salaryRateNoDeduction.rate - salaryRateNoDeduction.quickDeduction;
                annualTaxNoDeduction = salaryTaxNoDeduction + bonusTax;
            } else {
                // 并入综合所得模式下，无扣除时的税额
                annualTaxNoDeduction = taxableIncomeNoDeduction * applicableRateNoDeduction.rate - applicableRateNoDeduction.quickDeduction;
            }
            
            // 计算节省税额
            const taxSavingFromDeduction = annualTaxNoDeduction - annualTax;
            
            // 计算无社保公积金时的税额
            const taxableIncomeNoInsurance = Math.max(0, annualTotalIncome - basicDeduction - annualDeduction);
            let applicableRateNoInsurance = taxRateTable[0];
            for (const rate of taxRateTable) {
                if (taxableIncomeNoInsurance > rate.min && taxableIncomeNoInsurance <= rate.max) {
                    applicableRateNoInsurance = rate;
                    break;
                }
            }
            
            let annualTaxNoInsurance = 0;
            if (bonusTaxSeparate) {
                // 单独计税模式下，无社保公积金时的税额
                const salaryTaxableIncomeNoInsurance = Math.max(0, annualSalary - basicDeduction - annualDeduction);
                let salaryRateNoInsurance = taxRateTable[0];
                for (const rate of taxRateTable) {
                    if (salaryTaxableIncomeNoInsurance > rate.min && salaryTaxableIncomeNoInsurance <= rate.max) {
                        salaryRateNoInsurance = rate;
                        break;
                    }
                }
                const salaryTaxNoInsurance = salaryTaxableIncomeNoInsurance * salaryRateNoInsurance.rate - salaryRateNoInsurance.quickDeduction;
                annualTaxNoInsurance = salaryTaxNoInsurance + bonusTax;
            } else {
                // 并入综合所得模式下，无社保公积金时的税额
                annualTaxNoInsurance = taxableIncomeNoInsurance * applicableRateNoInsurance.rate - applicableRateNoInsurance.quickDeduction;
            }
            
            const taxSavingFromInsurance = annualTaxNoInsurance - annualTax;
            
            // 计算节省比例
            const totalSaving = taxSavingFromDeduction + taxSavingFromInsurance;
            const savingPercentage = annualTaxNoDeduction > 0 ? (totalSaving / annualTaxNoDeduction * 100).toFixed(1) : 0;
            
            // 更新结果显示
            document.getElementById('result-salary').textContent = `${formatCurrency(monthlySalary)} 元`;
            document.getElementById('result-bonus').textContent = `${formatCurrency(annualBonus)} 元`;
            document.getElementById('result-total-income').textContent = `${formatCurrency(annualTotalIncome)} 元`;
            document.getElementById('result-insurance').textContent = `${formatCurrency(annualInsurance)} 元`;
            document.getElementById('result-deduction').textContent = `${formatCurrency(annualDeduction)} 元`;
            document.getElementById('result-taxable-income').textContent = `${formatCurrency(taxableIncome)} 元`;
            document.getElementById('breakdown-rate').textContent = `${(applicableRate.rate * 100).toFixed(0)}%`;
            document.getElementById('breakdown-quick-deduction').textContent = `${formatCurrency(applicableRate.quickDeduction)} 元`;
            document.getElementById('breakdown-annual-tax').textContent = `${formatCurrency(annualTax)} 元`;
            document.getElementById('result-monthly-tax').textContent = `${formatCurrency(monthlyTax)} 元`;
            document.getElementById('result-annual-tax').textContent = `${formatCurrency(annualTax)} 元`;
            document.getElementById('result-after-tax-income').textContent = `${formatCurrency(afterTaxIncome)} 元`;
            
            // 更新应纳税所得额计算公式
            const formulaEquation = document.getElementById('formula-equation');
            if (bonusTaxSeparate) {
                formulaEquation.innerHTML = `综合所得: (${formatCurrency(annualSalary)} - 60,000 - ${formatCurrency(annualInsurance)} - ${formatCurrency(annualDeduction)}) = ${formatCurrency(taxableIncome)} 元<br>年终奖单独计税: ${formatCurrency(annualBonus)} 元`;
            } else {
                formulaEquation.innerHTML = `${formatCurrency(annualTotalIncome)} - 60,000 - ${formatCurrency(annualInsurance)} - ${formatCurrency(annualDeduction)} = ${formatCurrency(taxableIncome)} 元`;
            }
            
            // 更新税率预警
            updateRateWarning(applicableRate.warning);
            
            // 更新税收倒计时
            document.getElementById('countdown-amount').textContent = `¥${formatCurrency(countdownAmount)}`;
            document.getElementById('countdown-desc').innerHTML = countdownDesc;
            
            // 更新税收节省分析
            document.getElementById('tax-saving').textContent = `${formatCurrency(taxSavingFromDeduction)} 元`;
            document.getElementById('insurance-saving').textContent = `${formatCurrency(taxSavingFromInsurance)} 元`;
            document.getElementById('saving-percentage').textContent = `${savingPercentage}%`;
            document.getElementById('tax-saving-progress').style.width = `${Math.min(savingPercentage, 100)}%`;
            
            // 高亮显示当前税率级数
            highlightCurrentTaxRate(applicableRate.level);
            
            // 返回计算结果用于历史记录
            return {
                salary: monthlySalary,
                bonus: annualBonus,
                insurance: annualInsurance,
                deduction: annualDeduction,
                taxableIncome: taxableIncome,
                taxRate: applicableRate.rate,
                annualTax: annualTax,
                monthlyTax: monthlyTax,
                afterTaxIncome: afterTaxIncome,
                city: currentCity,
                bonusTaxMode: bonusTaxSeparate ? "单独计税" : "并入综合所得",
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('zh-CN')
            };
        }

        // 更新税率预警
        function updateRateWarning(warningLevel) {
            const rateWarningElement = document.getElementById('rate-warning');
            let warningText = '';
            let warningClass = '';
            
            switch(warningLevel) {
                case '低':
                    warningText = '低税负';
                    warningClass = 'warning-low';
                    break;
                case '中':
                    warningText = '中等税负';
                    warningClass = 'warning-medium';
                    break;
                case '高':
                case '极高':
                    warningText = '高税负';
                    warningClass = 'warning-high';
                    break;
            }
            
            rateWarningElement.textContent = warningText;
            rateWarningElement.className = `tax-rate-warning ${warningClass}`;
        }

        // 高亮显示当前税率级数
        function highlightCurrentTaxRate(currentLevel) {
            // 移除所有高亮
            document.querySelectorAll('#tax-table tbody tr').forEach(row => {
                row.classList.remove('current-tax-rate');
            });
            
            // 高亮当前税率级数
            const currentRow = document.getElementById(`tax-level-${currentLevel}`);
            if (currentRow) {
                currentRow.classList.add('current-tax-rate');
            }
        }

        // 生成税负优化建议
        function generateOptimizationSuggestions(result) {
            const suggestionsContainer = document.getElementById('optimization-suggestions');
            suggestionsContainer.innerHTML = '';
            
            const suggestions = [];
            
            // 分析当前税务情况，生成建议
            const monthlySalary = result.salary;
            const annualTax = result.annualTax;
            const taxRate = result.taxRate;
            const bonusTaxMode = result.bonusTaxMode;
            
            // 建议1：年终奖计税模式优化
            if (bonusTaxMode === "并入综合所得" && result.bonus > 0) {
                suggestions.push({
                    icon: 'fas fa-exchange-alt',
                    title: '考虑年终奖单独计税',
                    content: '年终奖单独计税可能比并入综合所得更节税，特别是在月薪较高的情况下。建议切换计税模式对比结果。'
                });
            }
            
            // 建议2：专项附加扣除优化
            if (result.deduction < 24000) {
                suggestions.push({
                    icon: 'fas fa-home',
                    title: '增加专项附加扣除',
                    content: '您当前的专项附加扣除较少，可以考虑申报住房租金、继续教育、赡养老人等扣除项目，每年最多可节省数千元税款。'
                });
            }
            
            // 建议3：商业健康保险
            if (taxRate >= 0.1) {
                suggestions.push({
                    icon: 'fas fa-heart',
                    title: '购买商业健康保险',
                    content: '购买符合规定的商业健康保险产品，每月可扣除200元，年度限额2400元。这是降低税负的有效方式之一。'
                });
            }
            
            // 建议4：企业年金
            if (monthlySalary > 20000) {
                suggestions.push({
                    icon: 'fas fa-piggy-bank',
                    title: '参加企业年金计划',
                    content: '企业年金缴费在不超过本人缴费工资计税基数4%标准内的部分，可以从个人当期的应纳税所得额中扣除。'
                });
            }
            
            // 建议5：公益捐赠
            if (annualTax > 5000) {
                suggestions.push({
                    icon: 'fas fa-hand-holding-heart',
                    title: '通过公益捐赠节税',
                    content: '个人通过公益性社会组织或国家机关的公益捐赠，在年度应纳税所得额30%以内的部分，准予在计算应纳税所得额时扣除。'
                });
            }
            
            // 如果建议太少，添加默认建议
            if (suggestions.length < 3) {
                suggestions.push({
                    icon: 'fas fa-university',
                    title: '合理规划收入结构',
                    content: '将部分工资收入转为符合条件的补贴、津贴或福利，如交通补贴、通讯补贴等，可以在一定限额内免税。'
                });
                
                suggestions.push({
                    icon: 'fas fa-baby',
                    title: '申报婴幼儿照护费用',
                    content: '有3岁以下婴幼儿的纳税人，每个婴幼儿每月可扣除1000元。如果您有符合条件的婴幼儿，请务必申报此项扣除。'
                });
            }
            
            // 生成建议HTML
            suggestions.forEach(suggestion => {
                const suggestionElement = document.createElement('div');
                suggestionElement.className = 'suggestion-item fade-in';
                suggestionElement.innerHTML = `
                    <div class="suggestion-icon">
                        <i class="${suggestion.icon}"></i>
                    </div>
                    <div class="suggestion-content">
                        <h4>${suggestion.title}</h4>
                        <p>${suggestion.content}</p>
                    </div>
                `;
                suggestionsContainer.appendChild(suggestionElement);
            });
        }

        // 更新税负模拟器
        function updateSimulator(baseResult) {
            const simulatorResults = document.getElementById('simulator-results');
            simulatorResults.innerHTML = '';
            
            const scenarios = [
                {
                    id: 'current',
                    name: '当前方案',
                    salary: baseResult.salary,
                    bonus: baseResult.bonus,
                    deduction: baseResult.deduction / 12
                },
                {
                    id: 'optimize',
                    name: '优化方案',
                    salary: baseResult.salary,
                    bonus: baseResult.bonus * 1.2, // 增加年终奖
                    deduction: baseResult.deduction / 12 * 1.5 // 增加扣除
                },
                {
                    id: 'increase-salary',
                    name: '增加月薪',
                    salary: baseResult.salary * 1.2,
                    bonus: baseResult.bonus,
                    deduction: baseResult.deduction / 12
                },
                {
                    id: 'increase-bonus',
                    name: '增加年终奖',
                    salary: baseResult.salary,
                    bonus: baseResult.bonus * 1.5,
                    deduction: baseResult.deduction / 12
                },
                {
                    id: 'deduction-max',
                    name: '最大化扣除',
                    salary: baseResult.salary,
                    bonus: baseResult.bonus,
                    deduction: 3000 // 假设最大化扣除
                }
            ];
            
            // 只显示前4个方案
            scenarios.slice(0, 4).forEach(scenario => {
                // 计算该方案的税额
                const annualSalary = scenario.salary * 12;
                const annualBonus = scenario.bonus;
                const annualDeduction = scenario.deduction * 12;
                const annualInsurance = baseResult.insurance;
                
                const basicDeduction = 60000;
                const taxableIncome = Math.max(0, annualSalary + annualBonus - basicDeduction - annualInsurance - annualDeduction);
                
                // 查找适用的税率
                let applicableRate = taxRateTable[0];
                for (const rate of taxRateTable) {
                    if (taxableIncome > rate.min && taxableIncome <= rate.max) {
                        applicableRate = rate;
                        break;
                    }
                }
                
                const annualTax = taxableIncome * applicableRate.rate - applicableRate.quickDeduction;
                const afterTaxIncome = annualSalary + annualBonus - annualTax;
                
                const resultElement = document.createElement('div');
                resultElement.className = 'simulator-result';
                resultElement.innerHTML = `
                    <div class="simulator-result-title">${scenario.name}</div>
                    <div class="simulator-result-item">
                        <span>月薪:</span>
                        <span>${formatCurrency(scenario.salary)} 元</span>
                    </div>
                    <div class="simulator-result-item">
                        <span>年终奖:</span>
                        <span>${formatCurrency(scenario.bonus)} 元</span>
                    </div>
                    <div class="simulator-result-item">
                        <span>年个税:</span>
                        <span style="font-weight: 700; color: var(--primary-color);">${formatCurrency(annualTax)} 元</span>
                    </div>
                    <div class="simulator-result-item">
                        <span>税后年收入:</span>
                        <span>${formatCurrency(afterTaxIncome)} 元</span>
                    </div>
                `;
                
                simulatorResults.appendChild(resultElement);
            });
        }

        // 更新税负排行榜
        function updateRanking() {
            const rankingContainer = document.getElementById('ranking-container');
            
            // 模拟排行榜数据
            const rankings = [
                { position: 1, name: '北京市 - 张先生', salary: 35000, tax: 48520 },
                { position: 2, name: '上海市 - 李女士', salary: 32000, tax: 41280 },
                { position: 3, name: '深圳市 - 王先生', salary: 28000, tax: 33600 },
                { position: 4, name: '广州市 - 刘女士', salary: 25000, tax: 26400 },
                { position: 5, name: '杭州市 - 陈先生', salary: 22000, tax: 21120 },
                { position: 6, name: '成都市 - 赵先生', salary: 18000, tax: 15840 },
                { position: 7, name: '武汉市 - 孙女士', salary: 15000, tax: 10800 },
                { position: 8, name: '南京市 - 周先生', salary: 13000, tax: 7560 },
                { position: 9, name: '西安市 - 吴女士', salary: 12000, tax: 6120 },
                { position: 10, name: '重庆市 - 郑先生', salary: 10000, tax: 3480 }
            ];
            
            // 清空现有内容
            rankingContainer.innerHTML = '';
            
            // 添加排行榜项
            rankings.forEach(rank => {
                const rankingItem = document.createElement('div');
                rankingItem.className = 'ranking-item fade-in';
                rankingItem.innerHTML = `
                    <div class="ranking-position">${rank.position}</div>
                    <div class="ranking-info">
                        <div class="ranking-name">${rank.name}</div>
                        <div class="ranking-details">
                            <span>月薪: ${formatCurrency(rank.salary)}元</span>
                            <span class="ranking-tax">年个税: ${formatCurrency(rank.tax)}元</span>
                        </div>
                    </div>
                `;
                rankingContainer.appendChild(rankingItem);
            });
        }

        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('taxHistoryChart').getContext('2d');
            
            // 模拟历史数据
            const labels = [];
            const taxData = [];
            
            // 生成过去12个月的数据
            const now = new Date();
            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                labels.push(`${date.getMonth() + 1}月`);
                
                // 模拟随机税负数据
                const baseTax = 2000;
                const variation = Math.random() * 1000 - 500;
                taxData.push(baseTax + variation);
            }
            
            // 如果有真实历史数据，使用真实数据
            if (taxHistory.length > 0) {
                // 使用最近的历史记录
                const recentHistory = taxHistory.slice(0, Math.min(12, taxHistory.length));
                labels.length = 0;
                taxData.length = 0;
                
                recentHistory.forEach((record, index) => {
                    labels.push(`记录${index + 1}`);
                    taxData.push(record.annualTax / 12); // 转换为月均税负
                });
            }
            
            // 销毁现有图表
            if (taxHistoryChart) {
                taxHistoryChart.destroy();
            }
            
            // 创建新图表
            taxHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '月均税负 (元)',
                        data: taxData,
                        borderColor: 'rgba(67, 97, 238, 1)',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '税额 (元)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            }
                        }
                    }
                }
            });
        }

        // 保存历史记录
        function saveToHistory(result) {
            // 创建历史记录对象
            const historyItem = {
                id: Date.now(),
                date: new Date().toLocaleString('zh-CN'),
                ...result
            };
            
            // 添加到历史记录数组
            taxHistory.unshift(historyItem);
            
            // 限制历史记录数量（最多10条）
            if (taxHistory.length > 10) {
                taxHistory = taxHistory.slice(0, 10);
            }
            
            // 保存到本地存储
            localStorage.setItem('taxHistory', JSON.stringify(taxHistory));
            
            // 更新历史记录显示
            updateHistoryDisplay();
            
            // 更新图表
            updateChart();
        }

        // 更新历史记录显示
        function updateHistoryDisplay() {
            const historyList = document.getElementById('history-list');
            const emptyHistory = document.getElementById('empty-history');
            
            // 清空历史记录列表
            historyList.innerHTML = '';
            
            if (taxHistory.length === 0) {
                // 显示空状态
                historyList.appendChild(emptyHistory);
                emptyHistory.style.display = 'block';
                return;
            }
            
            // 隐藏空状态
            emptyHistory.style.display = 'none';
            
            // 添加历史记录项
            taxHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item fade-in';
                historyItem.innerHTML = `
                    <div class="history-date">
                        <i class="far fa-calendar-alt"></i> ${item.date}
                        <span class="tag">${cityPolicies[item.city].name}</span>
                        <span class="tag">${item.bonusTaxMode}</span>
                    </div>
                    <div class="history-data">
                        <div class="history-data-item">
                            <span class="history-label">月薪工资</span>
                            <span class="history-value">${formatCurrency(item.salary)} 元</span>
                        </div>
                        <div class="history-data-item">
                            <span class="history-label">年度个税</span>
                            <span class="history-value">${formatCurrency(item.annualTax)} 元</span>
                        </div>
                        <div class="history-data-item">
                            <span class="history-label">税后年收入</span>
                            <span class="history-value">${formatCurrency(item.afterTaxIncome)} 元</span>
                        </div>
                    </div>
                `;
                
                // 添加点击事件，可以回填数据
                historyItem.addEventListener('click', () => {
                    fillFormWithHistory(item);
                });
                
                historyList.appendChild(historyItem);
            });
        }

        // 更新图表
        function updateChart() {
            if (taxHistory.length === 0) return;
            
            // 获取最近的历史记录
            const recentHistory = taxHistory.slice(0, Math.min(12, taxHistory.length));
            const labels = [];
            const taxData = [];
            
            recentHistory.forEach((record, index) => {
                labels.push(`记录${index + 1}`);
                taxData.push(record.annualTax / 12); // 转换为月均税负
            });
            
            // 更新图表数据
            taxHistoryChart.data.labels = labels;
            taxHistoryChart.data.datasets[0].data = taxData;
            taxHistoryChart.update();
        }

        // 加载历史记录
        function loadHistory() {
            const savedHistory = localStorage.getItem('taxHistory');
            if (savedHistory) {
                taxHistory = JSON.parse(savedHistory);
                updateHistoryDisplay();
            }
        }

        // 初始化事件监听器
        function initEventListeners() {
            // 计算按钮点击事件
            calculateBtn.addEventListener('click', () => {
                const result = calculateTax();
                saveToHistory(result);
                generateOptimizationSuggestions(result);
                updateSimulator(result);
                showNotification('个人所得税计算完成，已保存到历史记录', 'success');
            });
            
            // 收入输入框输入事件
            salaryInput.addEventListener('input', calculateTax);
            bonusInput.addEventListener('input', calculateTax);
            
            // 社保公积金输入事件
            pensionInput.addEventListener('input', calculateTax);
            medicalInput.addEventListener('input', calculateTax);
            unemploymentInput.addEventListener('input', calculateTax);
            housingInput.addEventListener('input', calculateTax);
            
            // 专项附加扣除输入事件
            const deductionInputs = [
                childrenEducationInput,
                continuingEducationInput,
                medicalTreatmentInput,
                housingLoanInput,
                housingRentInput,
                supportElderlyInput,
                infantCareInput,
                otherDeductionInput
            ];
            
            deductionInputs.forEach(input => {
                input.addEventListener('input', calculateTax);
            });
            
            // 城市选择按钮点击事件
            cityButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentCity = btn.dataset.city;
                    updateCityPolicy();
                    autoCalculateInsurance();
                });
            });
            
            // 工资变化时自动计算社保公积金
            salaryInput.addEventListener('input', autoCalculateInsurance);
            
            // 住房贷款利息和住房租金不能同时享受的逻辑
            housingLoanInput.addEventListener('input', function() {
                if (parseFloat(this.value) > 0) {
                    housingRentInput.value = 0;
                    housingRentInput.disabled = true;
                } else {
                    housingRentInput.disabled = false;
                }
                calculateTax();
            });
            
            housingRentInput.addEventListener('input', function() {
                if (parseFloat(this.value) > 0) {
                    housingLoanInput.value = 0;
                    housingLoanInput.disabled = true;
                } else {
                    housingLoanInput.disabled = false;
                }
                calculateTax();
            });
            
            // 模拟器按钮点击事件
            simulatorButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // 移除所有按钮的active类
                    simulatorButtons.forEach(b => b.classList.remove('active'));
                    // 为当前按钮添加active类
                    this.classList.add('active');
                    
                    // 根据场景更新模拟器
                    const scenario = this.dataset.scenario;
                    const result = calculateTax();
                    updateSimulatorForScenario(scenario, result);
                });
            });
            
            // 年终奖计税模式切换事件
            bonusTaxToggle.addEventListener('change', function() {
                bonusTaxSeparate = this.checked;
                updateBonusTaxMode();
                calculateTax();
                showNotification(`年终奖计税模式已切换为${bonusTaxSeparate ? '单独计税' : '并入综合所得'}`, 'info');
            });
        }

        // 根据场景更新模拟器
        function updateSimulatorForScenario(scenario, baseResult) {
            // 这里可以根据不同的场景生成不同的模拟结果
            updateSimulator(baseResult);
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `notification notification-${type} fade-in`;
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: ${type === 'success' ? '#4CAF50' : type === 'warning' ? '#ff9800' : type === 'error' ? '#f44336' : '#4361ee'}; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000; display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3秒后移除通知
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>